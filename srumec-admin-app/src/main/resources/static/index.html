<!doctype html>
<html lang="cs">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>≈†rumec ‚Äì Admin ud√°lost√≠</title>

    <!-- Leaflet CSS U≈Ω NEPOT≈òEBUJEME -->
    <link rel="stylesheet" href="/css/styles.css" />
</head>

<body class="app">

<header class="app-header">
    <div>
        <h2 class="app-title">≈†rumec ‚Äì admin ud√°lost√≠</h2>
        <div class="muted">
            Vol√° BE:
            <code>GET /events/get-pending</code>,
            <code>POST /events/{id}/approve</code>,
            <code>POST /events/{id}/reject</code>
        </div>
    </div>
    <div class="muted" id="statusText">Naƒç√≠t√°m‚Ä¶</div>
</header>

<div class="wrap">
    <!-- LEV√ù PANEL -->
    <div class="card">
        <div class="row">
            <strong>ƒåekaj√≠c√≠ ud√°losti</strong>
            <div class="muted" id="eventsCount"></div>
        </div>
        <div id="eventsList" class="list">Naƒç√≠t√°m‚Ä¶</div>
    </div>

    <!-- PRAV√ù PANEL -->
    <div class="card">
        <strong>Detail ud√°losti</strong>
        <div id="detail">
            <em>Vyber ud√°lost vlevo.</em>
        </div>

        <!-- Interaktivn√≠ OpenStreetMap v iframe -->
        <iframe
                id="mapFrame"
                title="Mapa m√≠sta ud√°losti"
                loading="lazy"
        ></iframe>
    </div>
</div>

<script>
    const api = {
        listPending: () => fetch('/admin/events/pending').then(r => r.json()),
        approve: id => fetch(`/admin/events/${id}/approve`, {method: 'POST'}),
        reject: id => fetch(`/admin/events/${id}/reject`, {method: 'POST'})
    };

    let state = {
        events: [],
        selectedId: null
    };

    function setStatus(msg) {
        document.getElementById('statusText').textContent = msg;
    }

    async function loadEvents() {
        setStatus('Naƒç√≠t√°m pending ud√°losti‚Ä¶');
        try {
            const data = await api.listPending();
            state.events = Array.isArray(data) ? data : [];
            document.getElementById('eventsCount').textContent =
                `${state.events.length} polo≈æek`;
            renderEventList();
            setStatus('Hotovo');

            if (state.selectedId) {
                const ev = state.events.find(e => e.id === state.selectedId);
                if (ev) {
                    renderDetail(ev);
                    ensureMap(ev);
                }
            }
        } catch (e) {
            console.error(e);
            document.getElementById('eventsList').innerHTML =
                '<div class="muted">Chyba p≈ôi naƒç√≠t√°n√≠ /admin/events/pending</div>';
            setStatus('Chyba p≈ôi naƒç√≠t√°n√≠');
        }
    }

    function renderEventList() {
        const list = document.getElementById('eventsList');
        if (!state.events.length) {
            list.innerHTML = '<div class="muted">≈Ω√°dn√© ud√°losti ke schv√°len√≠.</div>';
            return;
        }

        list.innerHTML = state.events
            .map(e => `
            <div class="item ${e.id === state.selectedId ? "selected" : ""}"
                 onclick="selectEvent('${e.id}')">
                <div><strong>${escapeHtml(e.title || '(bez n√°zvu)')}</strong></div>
                <div class="muted">${escapeHtml(e.description || '')}</div>
            </div>
        `)
            .join('');
    }

    function selectEvent(id) {
        const ev = state.events.find(e => e.id === id);
        if (!ev) return;
        state.selectedId = id;
        renderEventList();
        renderDetail(ev);
        ensureMap(ev);
    }

    function renderDetail(ev) {
        document.getElementById('detail').innerHTML = `
            <h3 class="detail-title">${escapeHtml(ev.title || '(bez n√°zvu)')}</h3>
            <div class="muted">ID: <code>${ev.id}</code></div>
            <p>${escapeHtml(ev.description || '')}</p>
            <div>üìç Lat/Lng: <code>${ev.latitude ?? '-'}</code> / <code>${ev.longitude ?? '-'}</code></div>
            <div>üë§ Organiz√°tor: <code>${ev.organizerRef || '-'}</code></div>
            <div>üïí ƒåas: <code>${ev.happenTime || '-'}</code></div>
            <div>üìå Stav: <code>${ev.status || 'pending'}</code></div>
            <div class="btns">
                <button class="btn success" onclick="onApprove('${ev.id}')">Schv√°lit</button>
                <button class="btn danger" onclick="onReject('${ev.id}')">Zam√≠tnout</button>
            </div>
        `;
    }

    async function onApprove(id) {
        if (!confirm('Opravdu schv√°lit?')) return;
        await api.approve(id);
        await loadEvents();
        alert('Ud√°lost schv√°lena.');
    }

    async function onReject(id) {
        if (!confirm('Opravdu zam√≠tnout?')) return;
        await api.reject(id);
        await loadEvents();
        alert('Ud√°lost zam√≠tnuta.');
    }

    // Interaktivn√≠ OpenStreetMap v iframe
    function ensureMap(ev) {
        const lat = Number(ev.latitude);
        const lng = Number(ev.longitude);
        const iframe = document.getElementById('mapFrame');

        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
            iframe.src = '';
            iframe.title = 'Mapa nen√≠ k dispozici (chyb√≠ sou≈ôadnice)';
            return;
        }

        const zoom = 14;
        const delta = 0.02; // velikost bboxu kolem bodu

        const left = lng - delta;
        const right = lng + delta;
        const bottom = lat - delta;
        const top = lat + delta;

        const bbox = `${left},${bottom},${right},${top}`;
        const marker = `${lat},${lng}`;

        const url =
            `https://www.openstreetmap.org/export/embed.html` +
            `?bbox=${encodeURIComponent(bbox)}` +
            `&layer=mapnik` +
            `&marker=${encodeURIComponent(marker)}`;

        iframe.src = url;
        iframe.title = `Mapa m√≠sta ud√°losti (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
    }

    function escapeHtml(s) {
        return (s ?? '').toString().replace(/[&<>"']/g, c => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
        }[c]));
    }

    window.selectEvent = selectEvent;
    window.onApprove = onApprove;
    window.onReject = onReject;

    loadEvents();
    setInterval(loadEvents, 10000);
</script>
<button id="logout-btn">Odhl√°sit se</button>

<script>
    document.getElementById("logout-btn").addEventListener("click", () => {
        window.location.href = "/auth/logout";
    });
</script>

</body>
</html>
