<!doctype html>
<html lang="cs">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>≈†rumec ‚Äì Admin ud√°lost√≠</title>

    <!-- Leaflet CSS -->
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NXZBfNQZ0WwIgtl7mKpVtGfZ8q3j6u1R5QqY+4o8E="
            crossorigin=""
    />

    <!-- Na≈°e CSS -->
    <link rel="stylesheet" href="/css/admin.css" />
</head>

<body class="app">

<header class="app-header">
    <div>
        <h2 class="app-title">≈†rumec ‚Äì admin ud√°lost√≠</h2>
        <div class="muted">
            Vol√° BE:
            <code>GET /admin/events/pending</code>,
            <code>POST /admin/events/{id}/approve</code>,
            <code>POST /admin/events/{id}/reject</code>
        </div>
    </div>
    <div class="muted" id="statusText">Naƒç√≠t√°m‚Ä¶</div>
</header>

<div class="wrap">
    <!-- LEV√ù PANEL: Seznam ud√°lost√≠ -->
    <div class="card">
        <div class="row">
            <strong>ƒåekaj√≠c√≠ ud√°losti</strong>
            <div class="muted" id="eventsCount"></div>
        </div>
        <div id="eventsList" class="list">Naƒç√≠t√°m‚Ä¶</div>
    </div>

    <!-- PRAV√ù PANEL: Detail + mapa -->
    <div class="card">
        <strong>Detail ud√°losti</strong>
        <div id="detail">
            <em>Vyber ud√°lost vlevo.</em>
        </div>
        <div id="map"></div>
    </div>
</div>

<!-- Leaflet JS -->
<script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
></script>

<script>
    // Leaflet ikonky fallback
    (function () {
        const Icon = L.Icon.Default;
        Icon.mergeOptions({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
        });
    })();

    const api = {
        listPending: () => fetch('/admin/events/pending').then(r => r.json()),
        approve: (id) => fetch(`/admin/events/${id}/approve`, {method: 'POST'}),
        reject: (id) => fetch(`/admin/events/${id}/reject`, {method: 'POST'})
    };


    let state = {
        events: [],
        selectedId: null,
        map: null,
        marker: null
    };

    function setStatus(msg) {
        document.getElementById('statusText').textContent = msg;
    }

    async function loadEvents() {
        setStatus('Naƒç√≠t√°m pending ud√°losti‚Ä¶');
        try {
            const data = await api.listPending();
            state.events = Array.isArray(data) ? data : [];
            document.getElementById('eventsCount').textContent = `${state.events.length} polo≈æek`;
            renderEventList();
            setStatus('Hotovo');

            if (state.selectedId) {
                const ev = state.events.find(e => e.id === state.selectedId);
                if (ev) {
                    renderDetail(ev);
                    ensureMap(ev);
                } else {
                    clearDetail();
                }
            }
        } catch (e) {
            console.error(e);
            document.getElementById('eventsList').innerHTML =
                '<div class="muted">Chyba p≈ôi naƒç√≠t√°n√≠ /admin/events/pending</div>';
            setStatus('Chyba p≈ôi naƒç√≠t√°n√≠');
        }
    }

    function renderEventList() {
        const list = document.getElementById('eventsList');
        if (!state.events.length) {
            list.innerHTML = '<div class="muted">≈Ω√°dn√© ud√°losti ke schv√°len√≠.</div>';
            return;
        }

        list.innerHTML = state.events.map(e => {
            const selectedClass = e.id === state.selectedId ? 'selected' : '';
            return `
            <div class="item ${selectedClass}" onclick="selectEvent('${e.id}')">
                <div><strong>${escapeHtml(e.title || '(bez n√°zvu)')}</strong></div>
                <div class="muted">${escapeHtml(e.description || '')}</div>
            </div>`;
        }).join('');
    }

    function selectEvent(id) {
        const ev = state.events.find(e => e.id === id);
        if (!ev) return;
        state.selectedId = id;
        renderEventList();
        renderDetail(ev);
        ensureMap(ev);
    }

    function clearDetail() {
        state.selectedId = null;
        document.getElementById('detail').innerHTML =
            '<em>Vyber ud√°lost vlevo.</em>';
        if (state.marker && state.map) {
            state.map.removeLayer(state.marker);
            state.marker = null;
        }
    }

    function renderDetail(ev) {
        document.getElementById('detail').innerHTML = `
        <h3 class="detail-title">${escapeHtml(ev.title || '(bez n√°zvu)')}</h3>
        <div class="muted">ID: <code>${ev.id}</code></div>
        <p>${escapeHtml(ev.description || '')}</p>
        <div>üìç Lat/Lng:
            <code>${ev.latitude ?? '-'}</code> /
            <code>${ev.longitude ?? '-'}</code>
        </div>
        <div>üë§ Organiz√°tor: <code>${ev.organizerRef || '-'}</code></div>
        <div>üïí ƒåas: <code>${ev.happenTime || '-'}</code></div>
        <div>üìå Stav: <code>${ev.status || 'pending'}</code></div>

        <div class="btns">
            <button class="btn success" onclick="onApprove('${ev.id}')">Schv√°lit</button>
            <button class="btn danger" onclick="onReject('${ev.id}')">Zam√≠tnout</button>
        </div>
        `;
    }

    async function onApprove(id) {
        if (!confirm('Opravdu schv√°lit tuto ud√°lost?')) return;
        await api.approve(id);
        await loadEvents();
        alert('Ud√°lost schv√°lena.');
    }

    async function onReject(id) {
        if (!confirm('Opravdu zam√≠tnout tuto ud√°lost?')) return;
        await api.reject(id);
        await loadEvents();
        alert('Ud√°lost zam√≠tnuta.');
    }

    function ensureMap(ev) {
        const lat = Number(ev.latitude);
        const lng = Number(ev.longitude);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        if (!state.map) {
            state.map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(state.map);
        } else {
            state.map.setView([lat, lng]);
        }

        if (state.marker) state.map.removeLayer(state.marker);
        state.marker = L.marker([lat, lng]).addTo(state.map);
    }

    function escapeHtml(s) {
        return (s ?? '').toString().replace(/[&<>"']/g, c => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        }[c]));
    }

    window.onApprove = onApprove;
    window.onReject = onReject;
    window.selectEvent = selectEvent;

    window.addEventListener('resize', () => {
        if (state.map) state.map.invalidateSize(true);
    });

    loadEvents();
    setInterval(loadEvents, 10000);
</script>

</body>
</html>
